<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attractor Explorer</title>
  <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/18237/18237428.png">
  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden; background: #000;
      font-family: Arial, sans-serif; color: white; user-select: none;
    }
    #ui {
      position: fixed;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 6px;
      max-width: 300px;
      z-index: 10;
      transition: opacity 0.5s ease;
    }
    #ui.hidden {
      opacity: 0;
      pointer-events: none;
    }
    label { display: block; margin-top: 8px; }
    input[type=range] { width: 100%; }
    select {
      width: 100%;
      margin-top: 6px;
      padding: 4px;
      background: #111;
      color: white;
      border: none;
      border-radius: 4px;
    }
    #infoBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(50, 50, 50, 0.8);
      width: 32px;
      height: 32px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
      line-height: 32px;
      cursor: pointer;
      user-select: none;
      z-index: 20;
      transition: background-color 0.3s ease;
    }
    #infoBtn:hover {
      background: rgba(100, 100, 100, 0.9);
    }
    #infoOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 14px;
      padding: 20px;
      box-sizing: border-box;
      z-index: 30;
      overflow-y: auto;
    }
    #infoContent {
      max-width: 400px;
      margin: 40px auto;
      background: #111;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
      position: relative;
    }
    #infoContent h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold;
      text-align: center;
      font-size: 18px;
    }
    #infoContent ul {
      padding-left: 20px;
      line-height: 1.5;
    }
    #closeInfo {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      user-select: none;
      color: #eee;
    }
    #closeInfo:hover {
      color: #fff;
    }

    #fullscreenBtn {
      position: fixed;
      top: 10px;
      right: 50px;
      background: rgba(50, 50, 50, 0.8);
      width: 32px;
      height: 32px;
      border-radius: 4px;
      color: white;
      font-size: 18px;
      text-align: center;
      line-height: 32px;
      cursor: pointer;
      user-select: none;
      z-index: 20;
      transition: background-color 0.3s ease;
    }

    #fullscreenBtn:hover {
      background: rgba(100, 100, 100, 0.9);
    }

    #ui.collapsed {
      max-width: 40px;
      padding: 5px;
      overflow: hidden;
      transition: max-width 0.3s ease;
    }

    #ui.collapsed *:not(#collapseBtn) {
      display: none;
    }

    #resetCameraBtn, #randomizeParamsBtn {
      position: fixed;
      top: 10px;
      background: rgba(50, 50, 50, 0.8);
      width: 32px;
      height: 32px;
      border-radius: 4px;
      color: white;
      font-size: 18px;
      text-align: center;
      line-height: 32px;
      cursor: pointer;
      user-select: none;
      z-index: 20;
      transition: background-color 0.3s ease;
    }

    #resetCameraBtn:hover,
    #randomizeParamsBtn:hover {
      background: rgba(100, 100, 100, 0.9);
    }

    #resetCameraBtn {
      right: 90px;
    }

    #randomizeParamsBtn {
      right: 130px;
    }

    #fpsCounter {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
<div id="ui">
  <button id="collapseBtn" title="Collapse Menu" style="float: right; background: none; border: none; color: white; font-size: 16px; cursor: pointer;">â€“</button>

  <label>
    <input type="checkbox" id="retroToggle" />
    Retro Mode
  </label>

  <label for="attractorSelect">Attractor:</label>
  <select id="attractorSelect">
    <option value="lorenz">Lorenz</option>
    <option value="halvorsen">Halvorsen</option>
    <option value="aizawa">Aizawa</option>
    <option value="chenlee">Chen-Lee</option>
  </select>

  <label for="presetSelect">Presets:</label>
  <select id="presetSelect"></select>

  <div id="params"></div>

  <div id="resetCameraBtn" title="Reset Camera">âŸ³</div>
  <div id="randomizeParamsBtn" title="Randomize Parameters">ðŸŽ²</div>
  <input type="color" id="colorPicker" title="Trajectory Color" style="
    position: fixed;
    top: 10px;
    right: 170px;
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: none;
    cursor: pointer;
    z-index: 20;
  ">
  <div id="fullscreenBtn" title="Toggle Fullscreen">â›¶</div>
  <div id="infoBtn" title="Info">i</div>

  <div id="fpsCounter">FPS: 0</div>
</div>

<div id="infoOverlay" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
  <div id="infoContent">
    <div id="closeInfo" title="Close Info">&times;</div>
    <h2 id="infoTitle">Attractor Explorer v20251001</h2>
    <ul>
      <li>Double-click anywhere to toggle screensaver mode.</li>
      <li>Drag to rotate the attractor view.</li>
      <li>Changes in parameters are applied and rendered in real time.</li>
      <li>PDEs systems solved numerically via 4th Runge-Kutta method.</li>
      <li>Enable <strong>Retro Mode</strong> for a pixelated, low-res visual style. Color scheme inspired by X-COM: Terror from the Deep.</li>
    </ul>

    <hr>

    <section id="aboutDev">
      <h3>About</h3>
      <div style="overflow-x: auto; background: #111; padding: 1em; border-radius: 8px;">
        <pre id="asciiArt" style="
          font-family: monospace;
          font-size: 7px;
          line-height: 7px;
          white-space: pre;
          margin: 0;
          color: rgb(255, 255, 255);
        ">
###############%%###############%%%%%%%%@@@@@@%%%@%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
%%%%%%%%%%%%%%%%%%%%%###%%%%%%%%%%%%%%%@@@@@@@@@@@%%%#*##%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@%#***#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@%%%%@@@@@@@@@@@@%%%%%#****%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
%%%%%%%%%%%%%%%%%%@@@@%@@@@%%%@%%%%@@@@@@@@@@%###**###***##%%%%%%@@@@@@@@@@@@@@@@@@@@@@@%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%%%%%#####****#%%%%##%@@@@@@@@@@@@@@@%%%%
%###########################%#########%%%%%%%%@@@@@@@%%%%%#*++=+*#%%%%%%@@@@@@@@@@%%%%%##
####%####################%%%##%%##%%%%%%%%%%%##***###%%%%##+*+===*#%%%%%%%%%%%%%%%%%%%%%%
#######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%*++++++=====++*##+++-==*#%%%%%%%%%%%%%%%%%%%%%
%##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@#+++++++====------++++*+=+#%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%*++++++==+===-----:-++*++=*%%%%%%%%%%%%%%%%%%%%%
###%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@#*++++===++==------::-=+#*=+###%%%%%%%%%%%%%%%%%%
#####%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%***#**++++=+++===---:-=*#****#%%%%%%#%%%%%%%%%%%%
#######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%%%%%%%##*=++*****+==-:=*%%#*##%%%%%%%%%%%%%%%%%%%
##########%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%#%%%#%##+--*####+==----+*+=++#%%%%%%%%%%%%%%%%%%%
#############%%%%%%%%%%%%%%%%%%%%%%%@@%####*****=--=+**+=------=+=-=*%%%%%%%%%%%%%%%%%%%%
#########%%#####%%%%%%%%%%%%%%%%%%%%%@%***+****+=----====----:-==+=+%%%%%%%%%%%%%%%%%%%%%
############%%####%%%%%%%%%%%%%%%@%%%@%**+++***+=---=+===------====#%%%%%%%%%%%%%%%%%%%%%
#############%%%#####%%%%%%%%%%%%%%%%%%#**+**##*+=+=-+*+=--------=*%%%%%%%%%%%%%%%%%%%%%%
#################%%#####%%%%%%%%%%%%%%%#****#%%###**=+=++-----=-=#%%%%%%%%%%%%%%%%%%%%%%%
##################%%%######%%%%%%%%%%%%##*%%%###*+==+**=-=---=*%%%%%%%%%%%%%%%%%%%%%%%%%%
####################%#####**##%%%%%%%%%%#*******++==-----==-=+##%%%%%%%%%%%%%%%%%%%%%%%%%
##########################%#####%%%%%%@@%%#**###**==----===-+#%%%%%%%%%%%%%%%%%%%%%%%%%%%
############################%%%%%%@@@@@@@@@%##*+++=---=====+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#####################%#%%%%%%%%@@@@@@@@@@@@@@%###**+**#**+-*%%%%%%%%%%%%%%###%%%%%%%%%%%%
###################%%@%%%%@@@@@@@%%%@@@@@@%%%@%@@%%%#+==---*#+*#%%%%%%%%%%%%%%%%%%%%%%%%%
#################%%%%%%%%%@@@@@@@%%@@@@@@@%******==------:++*#*==+*%%%%%%%%%%%%%%%%%%%%%%
###############%%%%%%%%%%@@@@@@@%%@@@@@%%%%****++==--=---+=*+##*++===+#%%%%%%%%%%%%%%%%%%
##############%%%%%%%%%%%@@@@@@%%%@@@@%#*+*#+++++===-=--*+**+#@#%%#*+*+**%%%%%%%%%%%%%%%%
#############%%%%%%%#%%%%%%@@@%%%@@@@@@@#*+@#+=++++=-=+##%#++%#%+#%*=*##*=+#%%%%%%%%%%%%%
############%%%%%%%%##%%%%%@%%%%%@@@@@@@@@##@@#++++++#%%%#++*#+#+#%#-*%%*#+=-+#%%%%%%%%%%
***#########%%%%%%%%%#%##%@#*%%%@@@@@@@%%@@@%@@@@#**###***++##*#*#%%=#%##@#==---%%%%%%%%%
*++*#######%%%%%%%%%%%%##%#+#%##@@@@%%%%%%%@%%%%@@@@%#***+**%#*###%%####%@#==-=-+%%%%%%%%
#****#####%%#%%%%%%#%@%%%#*%%%*@@@@%%%%%#%@@%%%@@@@@%%****+*@%#@%%%%%##%@@%*=+*==*%%%%%%%
##***####%%%###%%%%%%@%%%#%%%*%@@@@*#%%#%%@@%%%@@@@@%%#*+*+%@##@%%%%%*#@@@#+++#%**%%%%%%%
###***###%%%%###%%##%@%%#%%%##@@@@##%%%%%@@@@@@@%%%%%%#%***@@%#@%%%%%*%@@%*++*%@**%%%%%%%
###*****#%%%%######*#@@%%%@#*%@@@%#%%%%%@@@@@%%%%%%%##%##*%@@#*##%%%#+@@%*++=#@%*=#%%%%%%
#####*+*#%%%%#***####@@@@@%%%%@@@##%%%%@@@%%%%%%%#%%##%##+%@@****#%%*%@@*+++*%%#+=#%%%%%@
#####*+*%%%%%#*###%%%@@@@@@%%@@@###%%%%%%%%%%%%%%#%%#%***+%@%**#+#%%+@@#****##***+#%%%%%%
#####**#%%%%%%%%%%%%%@@@@@@@@@@%%%%%%*#%%%%%%%%@%#+*#*++++%@%**#+*%#+@%#%#*%**%#*+#%%%%%%
#######%%%%%%%%%%%%%@@@@@@@@@@@@@@#*+++#%%%%%@%%%%%%%#*++*%@%#%%++##+@@@@*%**#%#*+#%%%%%%
######%%%@@%%%%%%%%@@@@@@@@@@@@@%#*++++*#%%%%%%%%%@%#%+++#%@##%#*+++*@@%+#%%#**+**#%%%%%%
####*#%%%%%%%%%%@@@@@@@@@@@@@@%%#*###%%%%%%%%%%%%%#%@+*++@#%#%#*++++@@%####*==+*++##%%%%%
####%%%%%%%%@@@@@@@@@@@@@@@@%#######%%%%%%%%@@@@@%@@+**+#@%####*++==@@@%%*=-=##+=+####%%%
###%%%%%%%%%%@@@@@@@@@@@@@@@**####%%%%%%%%@@%%%@%%%**#+*%@%##**++--#@@@#+-==****++####%%%
###%%%%%%%%%%%@@@@@@@@@@@@@%###%%%%%%%%%%%%%@@@@@%**%#+*%%####++=-+@@@%+=**++*#*==#%%%%%%
%%#%%%%%%%%%%%%%%@@@@@@@@@@%@%%%%%%%%%%%%%%%@@%@%%**%**#@@####+#+-*@@@%**++++*++-=#%%%%%#
%%%%%%%%%%%%%%%@@@@@@@@@@@@%@%%%%%%%%%%%%%%@@@@%%*+*%+#%@@#%##**=-#@@@%%%%#*++====#%%%%%%
%###%%%%%%%%%%%%@@@@@@@@@@@%%%%%%%%%%%%%%%@@@@%%#*+*%+#@@@#%#*===+@@@@#*+*####****#%%%%%%
####%%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%##%%%@@@%##***+%*%@@@***=+**%@@@@@@@%+=+***+#%%%%%%%
##*#%%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%%%%%@%%#**#*+#*%@@@#+++%%@@@@@%%%#**+++==#%%%%%%%%
##*#%%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%%%%%@@#*+*#*+++%@@@#=*%%@@@@@#=++==*##*=#%%%%%%%%%
#%%%%%%%%%%%%%%%%@@@@@@@@@@@%%%%%%%%%%%%%%%@@#*+##++=#%@@@#+*#%@@@@%%%#*==***+#%%%%%%%%%%
%%##%%%%%%%%%%%%%@@@@@@@@@@@%%%%%%%%%%%%%%%%@#++%#+++#%@@@#+#%%%@@@%%%%%#**++*%%%%%%%%%%%
%#*#%%%%%%%%%%%%%@@@@@@@@@@@%%%%%%%%%%%%%%%%@*=*%#+++#%@@@%*%#@@@@@@@#*#####*#%%%%%%%%%%%
</pre>
      </div>
      <p style="margin-top: 1em;">
        <strong>Feel free</strong> to explore strange attractors and break things.
      </p>
    </section>
    <section>
    <h3>Changelog</h3>
  <br>v20251001 - Implemented ring buffer and various performance increases. Things should rund alot smoother </br>

<br>v20250915 - Added FPS counter and defined data type for other PDE systems</br>

<br>v20250309 - INITIAL RELEASE</nr>
  </section>

    </div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js";
(() => {
  // Wake Lock Setup
  let wakeLock = null;

  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Wake Lock is active');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock was released');
        });
      }
    } catch (err) {
      console.error(`Wake Lock error: ${err.name}, ${err.message}`);
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      requestWakeLock();
    }
  });

  requestWakeLock();

  function wrapAngle(angle) {
    return (angle % (Math.PI * 2) + Math.PI * 2) % (Math.PI * 2);
  }

  function lerpAngle(current, target, alpha) {
    let delta = target - current;

    // Shortest path across 2Ï€ wraparound
    if (delta > Math.PI) delta -= Math.PI * 2;
    if (delta < -Math.PI) delta += Math.PI * 2;

    return wrapAngle(current + delta * alpha);
  }
  
  const attractors = {
    lorenz: {
      name: 'Lorenz',
      scale: 3,
      presets: {
        'Base': { sigma: 10, rho: 28, beta: 8 / 3 },
        'Larger': { sigma: 14, rho: 46, beta: 4 },
        'Tiny': { sigma: 10, rho: 15, beta: 8 / 3 },
        'Culled': { sigma: 20, rho: 35, beta: 5 / 2 }
      },
      params: {
        sigma: { min: 0, max: 30, step: 0.1, value: 10 },
        rho: { min: 0, max: 50, step: 0.1, value: 28 },
        beta: { min: 0, max: 5, step: 0.01, value: 8/3 }
      },
      equation: (p, [x, y, z]) => {
        const { sigma, rho, beta } = p;
        return [
          sigma * (y - x),
          x * (rho - z) - y,
          x * y - beta * z
        ];
      },
      fixedPoint: [Math.sqrt(8), Math.sqrt(8), 27]
    },
    aizawa: {
      name: 'Aizawa',
      scale: 30,
      presets: {
        'Orbit': { a: 1.0, b: 0.5, c: 2.2, d: 3.2, e: 0.2, f: 0.15 },
        'Starflower': { a: 0.8, b: 0.6, c: 3.0, d: 4.0, e: 0.1, f: 0.2 },
        'Pulse': { a: 0.9, b: 0.5, c: 1.0, d: 4.5, e: 0.1, f: 0.05 },
        'Original': { a: 0.95, b: 0.7, c: 0.6, d: 3.5, e: 0.25, f: 0.1 }
      },
      params: {
        a: { min: 0, max: 2.0, step: 0.001, value: 1.0 },
        b: { min: 0, max: 0.5, step: 0.001, value: 0.5 },
        c: { min: 0, max: 20, step: 0.01, value: 2.2 },
        d: { min: 0, max: 2, step: 0.001, value: 3.2 },
        e: { min: 0, max: 10, step: 0.01, value: 0.2 },
        f: { min: 0, max: 0.5, step: 0.001, value: 0.15 }
      },
      equation: (p, [x, y, z]) => {
        const { a, b, c, d, e, f } = p;
        return [
          (z - b) * x - d * y,
          d * x + (z - b) * y,
          c + a * z - (Math.pow(z,3))/3 - (x*x + y*y) * (1 + e * z) + f * z * (x*x*x)
        ];
      },
      fixedPoint: [0, 0, 0]
    },
    halvorsen: {
      name: 'Halvorsen',
      scale: 10,
      presets: {
        'Default': { a: 1.41 },
        'Veil': { a: 1.48 },
        'Web': { a: 1.6 },
        'Bloom': { a: 1.29 }
      },
      params: {
        a: { min: 0.5, max: 2.0, step: 0.01, value: 1.41 }
      },
      equation: (p, [x, y, z]) => {
        const { a } = p;
        return [
          -a * x - 4 * y - 4 * z - y * y,
          -a * y - 4 * z - 4 * x - z * z,
          -a * z - 4 * x - 4 * y - x * x
        ];
      },
      fixedPoint: [0.1, 0, 0]
    },
    chenlee: {
  name: 'Chen-Lee',
  scale: 15,
  presets: {
    'Chaotic': { a: 5, b: -10, c: -0.38 },
    'Spiral': { a: 3, b: -8, c: -0.4 },
    'Torus': { a: 4, b: -9, c: -0.3 },
    'Orbital': { a: 6, b: -12, c: -0.35 }
  },
  params: {
    a: { min: -15, max: 15, step: 0.1, value: 5 },
    b: { min: -20, max: 0, step: 0.1, value: -10 },
    c: { min: -1, max: 1, step: 0.01, value: -0.38 }
  },
  equation: (p, [x, y, z]) => {
    const { a, b, c } = p;
    return [
      a * x - y * z,
      b * y + x * z,
      c * z + x * y / 3
    ];
  },
  fixedPoint: [0, 0, 0]
},

  };

  let scene, camera, renderer;
  let line, lineMaterial, lineGeometry;
  let attractorParams = {};
  let attractorFunc;
  let fixedPoint = [0, 0, 0];
  let points = [];
  let maxPoints = 1000;

  let isDragging = false;
  let previousMousePos = { x: 0, y: 0 };
  let rotation = { x: 0, y: 0 };
  let targetRotation = { x: 0, y: 0 };
  let zoom = 1;

  const dt = 0.005;
  let speed = 1.0;

  let screensaverMode = false;
  let autoRotateAngle = 0;

  const attractorSelect = document.getElementById('attractorSelect');
  const presetSelect = document.getElementById('presetSelect');
  const paramsDiv = document.getElementById('params');
  const uiElement = document.getElementById('ui');

  const infoBtn = document.getElementById('infoBtn');
  const infoOverlay = document.getElementById('infoOverlay');
  const closeInfo = document.getElementById('closeInfo');
  const fpsCounter = document.getElementById('fpsCounter');

  // FPS counter variables
  let frameCount = 0;
  let lastTime = performance.now();
  let fps = 0;

  function updateFPS() {
    frameCount++;
    const currentTime = performance.now();
    const elapsed = currentTime - lastTime;
    
    if (elapsed >= 1000) {
      fps = Math.round((frameCount * 1000) / elapsed);
      frameCount = 0;
      lastTime = currentTime;
      fpsCounter.textContent = `FPS: ${fps}`;
    }
  }

  function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000); // frustum size default=2000. 1000 wasn't enough?
    camera.position.set(0, 0, 100);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000);
    document.body.appendChild(renderer.domElement);

    lineMaterial = new THREE.LineBasicMaterial({ color: 0x3399ff, transparent: true, opacity: 0.8 });
    lineGeometry = new THREE.BufferGeometry();
    const initialPositions = new Float32Array(maxPoints * 3);
    lineGeometry.setAttribute('position', new THREE.BufferAttribute(initialPositions, 3));
    line = new THREE.Line(lineGeometry, lineMaterial);
    scene.add(line);

    window.addEventListener('resize', onWindowResize);
    renderer.domElement.addEventListener('mousedown', onMouseDown);
    renderer.domElement.addEventListener('mouseup', onMouseUp);
    renderer.domElement.addEventListener('mouseout', onMouseUp);
    renderer.domElement.addEventListener('mousemove', onMouseMove);
    renderer.domElement.addEventListener('wheel', onMouseWheel, { passive: false });

    renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
    renderer.domElement.addEventListener('touchmove', onTouchMove, { passive: false });
    renderer.domElement.addEventListener('touchend', onTouchEnd);

    const resetCameraBtn = document.getElementById('resetCameraBtn');
    const randomizeParamsBtn = document.getElementById('randomizeParamsBtn');

    resetCameraBtn.addEventListener('click', () => {
      targetRotation.x = 0;
      targetRotation.y = 0;
      zoom = 1;
    });

    randomizeParamsBtn.addEventListener('click', () => {
      const selected = attractorSelect.value;
      const params = attractors[selected].params;

      for (const key in params) {
        const param = params[key];
        const randValue = (Math.random() * (param.max - param.min)) + param.min;
        attractorParams[key] = randValue;
        document.getElementById(`param-${key}`).value = randValue;
      }

      updateParamLabels();
    });

    window.addEventListener('dblclick', () => {
      screensaverMode = !screensaverMode;
      uiElement.classList.toggle('hidden', screensaverMode);
    });

    infoBtn.addEventListener('click', () => {
      infoOverlay.style.display = 'block';
    });

    const collapseBtn = document.getElementById('collapseBtn');

    collapseBtn.addEventListener('click', () => {
      uiElement.classList.toggle('collapsed');
      collapseBtn.textContent = uiElement.classList.contains('collapsed') ? '+' : 'â€“';
      collapseBtn.title = uiElement.classList.contains('collapsed') ? 'Expand Menu' : 'Collapse Menu';
    });

    const fullscreenBtn = document.getElementById('fullscreenBtn');

    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.warn(`Error attempting to enable fullscreen: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    });

    const colorPicker = document.getElementById('colorPicker');
    colorPicker.value = '#3399ff'; // default trajectory color

    colorPicker.addEventListener('input', (e) => {
      const color = new THREE.Color(e.target.value);
      lineMaterial.color.set(color);
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'f') {
        fullscreenBtn.click();
      }
    });

    closeInfo.addEventListener('click', () => {
      infoOverlay.style.display = 'none';
    });
    infoOverlay.addEventListener('click', e => {
      if (e.target === infoOverlay) {
        infoOverlay.style.display = 'none';
      }
    });

    attractorSelect.addEventListener('change', () => {
      createUI();
      resetAttractor();
    });

    presetSelect.addEventListener('change', () => {
      const selected = attractorSelect.value;
      const preset = attractors[selected].presets[presetSelect.value];
      if (preset) {
        for (const key in preset) {
          document.getElementById(`param-${key}`).value = preset[key];
          attractorParams[key] = preset[key];
        }
        updateParamLabels();
      }
    });

    const retroToggle = document.getElementById('retroToggle');

    retroToggle.addEventListener('change', () => {
      if (retroToggle.checked) {
        renderer.setClearColor(0x012410);
        lineMaterial.color.set(0xABFA00);
        colorPicker.value = '#abfa00'; // sync picker
        // rendering at low resolution then upscaling
        renderer.setPixelRatio(1/4);
        renderer.domElement.style.imageRendering = 'pixelated';
      } else {
        renderer.setClearColor(0x000000);
        lineMaterial.color.set(0x3399ff);
        colorPicker.value = '#3399ff'; // sync picker
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.domElement.style.imageRendering = ''; 
      }

      onWindowResize(); // Resize renderer with new pixel ratio
    });

    createUI();
    resetAttractor();
  }

  function createUI() {
    paramsDiv.innerHTML = '';
    const selected = attractorSelect.value;
    const params = attractors[selected].params;
    const presets = attractors[selected].presets;
    attractorParams = {};

    presetSelect.innerHTML = '';
    for (const name in presets) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      presetSelect.appendChild(opt);
    }

    Object.keys(params).forEach(key => {
      const param = params[key];
      const label = document.createElement('label');
      label.textContent = `${key}: ${param.value.toFixed(3)}`;
      label.htmlFor = `param-${key}`;

      const input = document.createElement('input');
      input.type = 'range';
      input.id = `param-${key}`;
      input.min = param.min;
      input.max = param.max;
      input.step = param.step;
      input.value = param.value;

      input.addEventListener('input', () => {
        attractorParams[key] = parseFloat(input.value);
        label.textContent = `${key}: ${parseFloat(input.value).toFixed(3)}`;
      });

      attractorParams[key] = param.value;
      paramsDiv.appendChild(label);
      paramsDiv.appendChild(input);
    });

    const speedLabel = document.createElement('label');
    speedLabel.textContent = 'Speed: ' + speed.toFixed(2);
    const speedSlider = document.createElement('input');
    speedSlider.type = 'range';
    speedSlider.min = 0.1;
    speedSlider.max = 5;
    speedSlider.step = 0.1;
    speedSlider.value = speed;
    speedSlider.addEventListener('input', () => {
      speed = parseFloat(speedSlider.value);
      speedLabel.textContent = 'Speed: ' + speed.toFixed(2);
    });

    paramsDiv.appendChild(speedLabel);
    paramsDiv.appendChild(speedSlider);

    const allowedMaxPoints = [10, 100, 1000, 2000, 3000, 4000, 5000];

    const maxPointsLabel = document.createElement('label');
    maxPointsLabel.textContent = 'Trail length: ' + maxPoints;

    const maxPointsSlider = document.createElement('input');
    maxPointsSlider.type = 'range';
    maxPointsSlider.min = 0;
    maxPointsSlider.max = allowedMaxPoints.length - 1;
    maxPointsSlider.step = 1;
    maxPointsSlider.value = allowedMaxPoints.indexOf(maxPoints);

    maxPointsSlider.addEventListener('input', () => {
      const selectedIndex = parseInt(maxPointsSlider.value);
      maxPoints = allowedMaxPoints[selectedIndex];
      maxPointsLabel.textContent = 'Trail length: ' + maxPoints;
      updateBufferGeometry();
    });

    paramsDiv.appendChild(maxPointsLabel);
    paramsDiv.appendChild(maxPointsSlider);
  }

  function updateParamLabels() {
    Object.entries(attractorParams).forEach(([key, value]) => {
      const label = document.querySelector(`label[for="param-${key}"]`);
      if (label) {
        label.textContent = `${key}: ${value.toFixed(3)}`;
      }
    });
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function onMouseDown(event) {
    isDragging = true;
    previousMousePos.x = event.clientX;
    previousMousePos.y = event.clientY;
  }

  function onMouseUp() {
    isDragging = false;
  }

  function onMouseMove(event) {
    if (!isDragging || screensaverMode) return;
    const deltaX = event.clientX - previousMousePos.x;
    const deltaY = event.clientY - previousMousePos.y;
    targetRotation.y = wrapAngle(targetRotation.y + deltaX * 0.005);
    targetRotation.x = wrapAngle(targetRotation.x + deltaY * 0.005);
    previousMousePos.x = event.clientX;
    previousMousePos.y = event.clientY;
  }

  function onMouseWheel(event) {
    event.preventDefault();
    zoom += event.deltaY * -0.0015;
    zoom = Math.min(Math.max(0.1, zoom), 5);
  }

  let lastTouchDist = 0;
  let lastTouch = null;

  function getTouchDist(touches) {
    if (touches.length < 2) return 0;
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function onTouchStart(event) {
    if (event.touches.length === 1) {
      isDragging = true;
      lastTouch = { x: event.touches[0].clientX, y: event.touches[0].clientY };
    } else if (event.touches.length === 2) {
      isDragging = false;
      lastTouchDist = getTouchDist(event.touches);
    }
  }

  function onTouchMove(event) {
    event.preventDefault(); // Prevent page scrolling

    if (screensaverMode) return;

    if (event.touches.length === 1 && isDragging && lastTouch) {
      const deltaX = event.touches[0].clientX - lastTouch.x;
      const deltaY = event.touches[0].clientY - lastTouch.y;
      targetRotation.y = wrapAngle(targetRotation.y + deltaX * 0.005);
      targetRotation.x = wrapAngle(targetRotation.x + deltaY * 0.005);
      lastTouch = { x: event.touches[0].clientX, y: event.touches[0].clientY };
    } else if (event.touches.length === 2) {
      const dist = getTouchDist(event.touches);
      const delta = dist - lastTouchDist;
      zoom += delta * 0.005;
      zoom = Math.min(Math.max(0.1, zoom), 5);
      lastTouchDist = dist;
    }
  }

  function onTouchEnd(event) {
    isDragging = false;
    lastTouch = null;
  }

  function resetAttractor() {
    points = [];
    const selected = attractorSelect.value;
    fixedPoint = attractors[selected].fixedPoint;
    attractorFunc = attractors[selected].equation;
    scale = attractors[selected].scale;
    currentPoint = fixedPoint.map(v => v + (Math.random() - 0.5) * 0.1);
    points.push(currentPoint.slice());
    updateBufferGeometry();
  }

  function updateBufferGeometry() {
    const newPositions = new Float32Array(maxPoints * 3);
    lineGeometry.setAttribute('position', new THREE.BufferAttribute(newPositions, 3));
    lineGeometry.attributes.position.needsUpdate = true;
    lineGeometry.setDrawRange(0, points.length);
  }

  function rk4Step(f, p, pt) {
    const h = dt * speed;

    const k1 = f(p, pt);
    const pt2 = pt.map((v, i) => v + 0.5 * h * k1[i]);
    const k2 = f(p, pt2);

    const pt3 = pt.map((v, i) => v + 0.5 * h * k2[i]);
    const k3 = f(p, pt3);

    const pt4 = pt.map((v, i) => v + h * k3[i]);
    const k4 = f(p, pt4);

    return pt.map((v, i) => v + (h / 6) * (k1[i] + 2 * k2[i] + 2 * k3[i] + k4[i]));
  }

  function updatePoints() {
    currentPoint = rk4Step(attractorFunc, attractorParams, currentPoint);
    if (points.length >= maxPoints) points.shift();
    points.push(currentPoint.slice());
  }

  function updateLineGeometry() {
    const positions = lineGeometry.attributes.position.array;
    const lastIndex = points.length - 1;
    
    for (let i = 0; i < points.length; i++) {
      const p = points[i];
      positions[3 * i] = (p[0] - fixedPoint[0]) * scale;
      positions[3 * i + 1] = (p[1] - fixedPoint[1]) * scale;
      positions[3 * i + 2] = (p[2] - fixedPoint[2]) * scale;
    }
    
    // Only update the necessary portion of the buffer
    lineGeometry.setDrawRange(0, points.length);
    lineGeometry.attributes.position.needsUpdate = true;
  }

  function animate() {
    requestAnimationFrame(animate);
    
    // Update FPS counter
    updateFPS();
    
    updatePoints();
    updateLineGeometry();

    if (screensaverMode) {
      autoRotateAngle = (autoRotateAngle + 0.001) % (Math.PI * 2);
      rotation.y = autoRotateAngle;
      rotation.x = Math.sin(autoRotateAngle * 0.5) * 0.5;
    } else {
      rotation.x = lerpAngle(rotation.x, targetRotation.x, 0.1);
      rotation.y = lerpAngle(rotation.y, targetRotation.y, 0.1);
    }

    line.rotation.x = rotation.x;
    line.rotation.y = rotation.y;

    camera.position.set(0, 0, 100 / zoom);
    camera.lookAt(0, 0, 0);
    renderer.render(scene, camera);
  }

  let currentPoint = [0, 0, 0];
  let scale = 10;

  init();
  animate();
})();
</script>
</body>
</html>